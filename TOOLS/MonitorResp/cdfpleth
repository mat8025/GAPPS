#! /usr/local/GASP/bin/spi 
#/* -*- c -*- */
# "$Id: cdfpleth,v 1.2 2004/09/16 03:12:30 mark Exp mark $" 


include /usr/local/GASP/GASP-3.0.0/TOOLS/PLOT/plotlib

fname = $2

 wpc = $3
      if (wpc @= "")
          wpc = 4


proc DrawAxis(ww)
{

  // should be in mins

      rs = w_getRS(ww)
	//<<" $_cproc $ww $rs \n"
      
      rx = rs[1] 
      ry = rs[2]
      rX = rs[3] 
      rY = rs[4]

      //<<" $rs \n"

            dy = (rY - ry )

            dx = (rX -rx)

	    ix = get_incr (dx)

            iy = get_incr ( dy)

      //<<" incr $ix $iy \n"

            int irx = rx/ix

            rx = irx * ixx

      //      <<" drawaxis $rx a$ry $rX $rY \n"

            int iry = ry/iy
            ry = iry * iy

            W_SetPen(ww,"black")

            ticks(ww,1,rx,rX,ix,0.02)

            ticks(ww,2,ry,rY,iy,0.02)

            axnum(ww,1,rx+ix,rX-ix,ix,2.0,"3.0f")

            axnum(ww,2,ry+iy,rY,10,3.0,"g")

        w_clipborder(ww)
}




///////////////////////   PLETH     ////////////////////////////////////
float Red[]
float IR[]

lstem = ""

normalize = 1

 do_IR = 1
 do_Red = 1



NPV = 10

      // want multiple scales - not just 2 

proc RedrawPars()
{

      RS2=W_GetRS(aw)

      rxmin = RS2[1]
      rxmax = RS2[3]
      rymin = RS2[2]
      rymax = RS2[4]


<<" $_cproc %V $rxmin $rxmax  $rymin $rymax \n"

      //<<" %6.2f $RS \n"
      // need different Yscales
      if (do47) {

      DrawGline(s47gl,"scales",rxmin,2000,rxmax,3000,"savescales",1)    
 
      }


      DrawGline(irgl,"scales",rxmin,plymin,rxmax,plymax,"savescales",0)
      if (do_Red)
      DrawGline(redgl,"scales",rxmin,plymin,rxmax,plymax,"savescales",0)

      // make yscale 0 120
      if (doECG) {

      DrawGline(rrgl,"scales",rxmin,0,rxmax,100,"savescales",0)    

      }

      //      RedrawGlines(plw)
      //      W_SetRS(RS2)

      // SetGwindow(aw,"scales",rxmin,0,rxmax,100,"savescales",0)    

  }



proc ReadPulseFile( Fh)
{

  R = ReadRecord(Fh,"type","int","col",2,24,"col:==",0,wpc,"ncols",11)

  maxpts = Caz(R)

  dmn = Cab(R)

 <<" ascii read  R array  %v $maxpts  $dmn\n"

 PG = R[*][6]

    // <<" PG $PG[0;NPV] \n"

 PG = 4|^PG

 <<" PG $PG[0;NPV] \n"
  // either 0 ,1,2, or 3 indicating gain of 1 ,4 , 16 or 64

 RD = R[*][4]

 RD = 4|^RD

 IRD = R[*][5]

 IRD = 4^IRD

 Red = R[*][8]

 <<" preNorm %10.0f $Red[0;NPV] \n"
 <<" PG $PG[0;NPV] \n"

 rsz = Caz(Red)

 dmn = Cab(Red)

 <<" %v $rsz $dmn\n"
  // apply normalization ?

  if (normalize) {
  Red = Red / PG 
  Red = Red / RD
  }

 <<" postNorm %10.0f $Red[0;NPV] \n"

 Redimn(Red)

 dmn = Cab(Red)

 <<" after Redimn $dmn \n"

 maxpts = Caz(Red)

 <<" %v $maxpts in Red array \n"

 IR = R[*][9]

 <<" $dmn $(typeof(IR))\n"

  Redimn(IR)

  if (normalize) {
   IR = IR /PG
   IR = IR/ IRD
  }

 maxirpts = Caz(IR)

 <<" %v $maxirpts  \n"


Fadc = R[*][3]
 
//<<" $Fadc \n"
 
sz = Caz(Fadc)
   
checkskip = 0  
  if (checkskip) {
 
<<" $sz \n"
  nskips = 0
  last_val = 0
   for (i= 0 ; i < sz ; i++) {
    val = Fadc[i]
    if ( i > 0) {
    if ((val - last_val) != 2) {
     <<" $i $val $Fadc[i-1] $Fadc[i] \n"
       nskips++
    }
    }
    last_val = val
   }
 
 
<<" DONE $nskips \n"
  }

   return maxpts
}




  B= ofr("${fname}.dat")

  maxpts = ReadPulseFile(B)

<<" $maxpts \n"


  ctname = fname

  fstem = Spat(ctname,".","<","<")

  if (fstem @= "")
      fstem = ctname

  lstem = Spat(fstem,"/",">","<")

  <<" $ctname $fstem $lstem \n"

  if (lstem @= "") 
     lstem = fstem

   ctname = lstem

// check Red &IR

   <<" %v $ctname \n"

  //  mm=MinMax(IR)

  irsz = Caz(IR)

   <<" %v $irsz \n"


  mm=Stats(IR[100;irsz-1])

<<" $mm \n"

     // make sdsize arg

  plymin = mm[1] - 1.1 * mm[4]

  plymax = mm[1] + 1.1 * mm[4]

<<"%V %e $mm[1] $mm[4] \n"
<<"%V %e $plymin $plymax \n"

  mm=Stats(Red[100;maxpts-1])

  yrmin = mm[1] - 1.1 * mm[4]

  if (yrmin < 0) yrmin = 0.0

  yrmax = mm[1] + 1.1 * mm[4]
  
  if (yrmin < ymin) plymin = yrmin

  if (plymin < 0) plymin = 0.0

  if (yrmax > plymax)
        plymax = yrmax

  float maxy = 5.0E8
	  if (plymax > ymax)
              plymax = ymax

<<"%V %e $mm[1] $mm[4] \n"

   dtp = 1.0/50.0

   XP= Fgen(maxpts,0,dtp)

<<" $maxpts %v $dtp \n"

    resptime = maxpts * dtp

   npts = maxpts


/////////////////////////////// 4700 RESP WAVE /////////////////////////////

do47 = 1

		if (do47) {

A = ofr("${fname}.wav")


R = ReadRecord(A,"type","int")
sz = Caz(R)
dmn = Cab(R)


<<" $sz $dmn \n"

//<<" $R \n"


SO2 = R[*][1]

      //      <<" $SO2[0;2000] \n"

sz = Caz(SO2)

  Redimn(SO2)

   MM= Stats(SO2)

<<" %6.2f $(typeof(MM)) $MM \n"

  // plot Spo2 V Fadc

      ymin = 2000
      ymax = 3000
      xmin = 0.0

    dtr = 1.0/250.0

    XR= Fgen(sz,0,dtr)
    
    xmax = sz * dtr
    resptime = xmax

}



 Graphic = CheckGwm()

<<" Done $maxpts \n"

<<" %v $Graphic \n"



if (! Graphic) STOP!


<<" %V $xmin $xmax  $dtr\n"

   aw= CreateGwindow("title","Resrp47","scales",xmin,ymin,xmax,ymax,"savescales",1)

    //<<" CGW $aw \n"

    SetGwindow(aw,"resize",0.1,0.1,0.9,0.90,0)
    SetGwindow(aw,"clip",0.1,0.1,0.8,0.9,"drawon")

    Gsync!

	   dmn = Cab(SO2)

<<" $dmn \n"


       s47gl=CreateGline("wid",aw,"type","XY","xvec",XR,"yvec",SO2,"color", "green","usescales",1)
       DrawGline(s47gl)



/////////////////////////////// ECG WAVE /////////////////////////////


doECG = 0

  if (doECG) {

C= ofr("${fname}.ri")

R3 = ReadRecord(C,"type","float")

ecgsz = Caz(R3)

dmn = Cab(R3)

<<" %V $ecgsz $dmn \n"

<<" $R3[0;10][*] \n"

  RR = R3[*][5] 
  Redimn(RR)

//  XVRI = Fgen(ecgsz,0,11)

  XVRI = R3[*][1]
  Redimn(XVRI)

      ymin = 0
      ymax = 120
      xmin = 0
      xmax = XVRI[ecgsz-1]

  SetGwindow(aw,"scales",xmin,ymin,xmax,ymax,"savescales",0)    

  rrgl=CreateGline("wid",aw,"type","XY","xvec",XVRI,"yvec",RR,"color", "red","usescales",0)
  DrawGline(rrgl)

}


//////////////////////////////////////////////////////////////////////////////////////////////////////



  //  interactive redraw

         plw = aw

<<" pleth scales $plymin  $plymax $yrmax \n"

    SetGwindow(plw,"scales",0,plymin,resptime,plymax,"savescales",0)

  // scale red to match ir

 scalered = 5.0

     if (do_Red) {
 redgl=CreateGline("wid",plw,"type",2,"xvec",XP,"yvec",scalered * Red,"color","red","name","RED","usescales",0)
       DrawGline(redgl)
      }


     if (do_IR) {
       irgl=CreateGline("wid",plw,"type",2,"xvec",XP,"yvec",IR,"color","blue","name","IR","usescales",0)
       DrawGline(irgl)
     }


      // redraw
      // if not gwm -exit


  // put some WOS - to control zooming

    woysp = 0.03
    woht = 0.07

    woy = 0.8
    woY = woy + woht

    woxwd = 0.09

    wox = 0.9
    woX = wox + woxwd

    zoywo=w_CreateWO(plw,"ONOFF","ZOY",1,wox,woy,woX,woY,2,"red","medium","white")

    woset(zoywo,"help","Zoom out Y axis")

    woY = woy - woysp
    woy = woY - woht

    ziywo=w_CreateWO(plw,"ONOFF","ZIY",1,wox,woy,woX,woY,2,"blue","medium","white")

    woset(ziywo,"help","Zoom in Y axis")

    woY = woy - woysp
    woy = woY - woht

    zoxwo=w_CreateWO(plw,"ONOFF","ZOX",1,wox,woy,woX,woY,2,"red","medium","white")

    woset(zoxwo,"help","Zoom out X axis")

    woY = woy - woysp
    woy = woY - woht

    zixwo=w_CreateWO(plw,"ONOFF","ZIX",1,wox,woy,woX,woY,2,"blue","medium","white")

    woset(zixwo,"help","Zoom in X axis")

    woY = woy - woysp
    woy = woY - woht

    puywo=w_CreateWO(plw,"ONOFF","PUY",1,wox,woy,woX,woY,2,"blue","medium","white")
    woset(puwwo,"help","Pan up Y axis")

    woY = woy - woysp
    woy = woY - woht

    pdywo=w_CreateWO(plw,"ONOFF","PDY",1,wox,woy,woX,woY,2,"blue","medium","white")
    woset(pdywo,"help","Pan down ")

    woY = woy - woysp
    woy = woY - woht

    plwo=w_CreateWO(plw,"ONOFF","PANL",1,wox,woy,woX,woY,2,"blue","medium","white")
    woset(plwo,"help","Pan left ")

    woY = woy - woysp
    woy = woY - woht

    prwo=w_CreateWO(plw,"ONOFF","PANR",1,wox,woy,woX,woY,2,"red","medium","white")
    woset(prwo,"help","Pan right ")


  //////////////////

   pfname =  "${fname}_resp.ps"

     scrollr = 0
     lscroll = 0


   while (1) {

    WoRedraw(plw)

    zoomit = 0

    w_activate(plw)

    msg = MessageWait(Minfo)

<<" $msg \n"

   if ( ! (msg @= "NO_MSG")) {

    zmn = msg 
    winid = Minfo[2]

    if ( msg @= "PRINT" ) {
     open_laser(pfname)
     scr_laser(plw)
     gsync()
    }

    if (msg @= "ZOY") {
      ZoomOutYaxis(plw)
      //<<" %V $ymax $ymin \n"
      zoomit = 1
    }

    if (msg @= "ZOX") {
      ZoomOutXaxis(aw)
      zoomit = 1
    }

    if (msg @= "PUY") {
      SetGwindow(aw,"usescales",0)
      PanUp(aw)
      zoomit = 1
      scrollr = 0
     lscroll = 0
    }

    if (msg @= "PDY") {
      SetGwindow(aw,"usescales",0)
      PanDown(aw)
      zoomit = 1
      scrollr = 0
     lscroll = 0
    }

    if (msg @= "PANL") {
      PanLeft(aw)
      zoomit = 1
      scrollr = 0
      lscroll = 0
    }


    if (msg @= "PANR") {
      PanRight(aw)
      zoomit = 1
      scrollr = 0
      lscroll = 0
    }


    if ((msg @= "ZIY")) {
      ZoomInYaxis(plw)
      zoomit = 1
    }

    if ((msg @= "ZIX")) {
      ZoomInXaxis(aw)
      zoomit = 1
    }


    if ( (msg @= "REDRAW") || (msg @= "RESIZE") || (msg @= "RESCALE") ||  zoomit ||  (msg @= "PRINT")) {

      SetGwindow(aw,"clearpixmap","clearclip","clear")

      RedrawPars()

      w_clipborder(aw)

      <<" ShowFile \n"

      ShowFileN(aw, ctname)

      DrawAxis(aw)

      SetGwindow(aw,"showpixmap","store")

    }


    if ( (msg @= "PRINT") ) {
          CloseLaser()
          laser_scr(plw)
          gsync()
              <<" cat $pfname | lpr "
              si_pause(5)
              <" cat $pfname | lpr "

    }


   }


      if (scrollr) {
      PanRight(aw)
      SetGwindow(aw,"clearpixmap","clearclip")
      RedrawPars()
      SetGwindow(aw,"showpixmap","store")
      }

      if (lscroll) {
      PanLeft(aw)
      SetGwindow(aw,"clearpixmap","clearclip","clear")
      RedrawPars()
      SetGwindow(aw,"showpixmap","store")

      }


   }



 ///////////////////////////////////////////////////////////////////



