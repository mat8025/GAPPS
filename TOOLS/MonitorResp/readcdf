#! /usr/local/GASP/bin/spi
#/* -*- c -*- */
# "$Id: readcdf,v 1.1 2004/10/11 04:54:40 mark Exp mark $" 

SetDebug(0)


uint PV[8192]
es_time = 0
el_time = 0
f_time = 1

proc    ShowTime() 
{
   bscan(UC[0],0,tag,ltime)
   ttime = localtime(ltime)
   <<"255 1 $ltime $ttime : $where \n"
   
   if ( ltime > start_time) {
            start_op = 1
   }

   //   ooc:  es_time = ltime 
   if (f_time ) { es_time = ltime ; f_time = 0 ; }

   el_time = ltime - es_time
}

ushort tstamp

proc ShowGOP()
{
   bscan(UC[0],0,tag,pr,spo2,pi)
   bscan(UC[45],0,tstamp)

   ms = sele("$tstamp",-1,3)

   <<"$channel $tag %f $pr $spo2 $pi %d  ${el_time}.$ms\n"
}


proc ShowECG()
{
  
   bscan(UC[0],0,tag,pr,ecgrr)
   bscan(UC[9],0,tstamp)
   ms = sele("$tstamp",-1,3)
   <<"$channel $tag %f $pr $ecgrr %d ${el_time}.$ms\n"
}

int pvi = 0;

proc   ShowPleth()
{
//<<" found 50Hz %x $UC \n"
   bscan(UC[0],0,tag,rtype,fadc,redrv,irdrv,gain,led,redv,irv,dmax)
//<<"$channel $tag $rtype $fadc $redrv $irdrv $gain $led %u $redv %u $irv %u $dmax :$where\n"
   si = pvi
   pvi += packv(PV[pvi],fadc,redrv,irdrv,gain,led,redv,irv,dmax)
   fi = pvi -1
//  <<" %v $si $fi \n\n"
   pvsub = PV[si;fi]
//   <<"$channel $tag $rtype %6.0f $pvsub \n"
//   <<"$channel $tag $rtype %u $pvsub \n"
   <<"$channel $tag $rtype  $pvsub \n"
   if (pvi > 4096)
       pvi = 0
}


start_op = 0
op_pleth = 1
op_time = 1
op_gop = 1
op_ecg = 1


cdfile = $2
if (cdfile @= "")
cdfile = "test.cdf"

uint start_time = 0

  if (!($3 @= ""))
   start_time = $3

     //     <<" %v $start_time \n"



char tag
char rtype
float pr
float spo2
float ecgrr
float pi
int ltime 



uint fadc
char redrv;
char irdrv
char led
char gain
	      ushort diag;
	      ushort sdflag;
              uint unk = 0;

uint redv
uint irv
uint dmax
         


int nsorecs = 0
int n39recs = 0
int ndarecs = 0


CheckMemory(0)
A=ofr(cdfile)

 ngops = 0
 npleth = 0
// readvec supply buffer - return nitems read - or error code

uchar C[10]

uchar channel

ushort nb

uchar UC[8192]

 fsz = fstat(cdfile,"size")

//<<" $cdfile $fsz \n"

   sz=v_read(A,UC,27)

<<" %c $UC[0;27] \n"

// read past magic cookie and version number

 while (1) {

   where = ftell(A)

   sz=v_read(A,C,3)

   if (sz != 3) break

      bscan(C[0],0,channel,nb)

   if (nb > 2000) {
   <<[2]"%v $channel NB $nb \n"
   }
   else {
   nir=v_read(A,UC,nb)
 
   if (nir < nb ) break
   rectype = UC[0]

   if (channel == 255 && rectype == 1 ) {
        ShowTime()
   }
   else if (rectype == 1) {
                ngops++
                if (op_gop && start_op) {
		  ShowGOP()
		}

   }
   else if (rectype == 2) {
                if (op_ecg && start_op) 
                ShowECG()
   }
   else if (rectype == 6) {
     npleth++
     if (UC[1] == 24  && op_pleth  && start_op ) {
       ShowPleth()
    }
   }
 }

   //   if (ngops > 100)           break

}

<<" %v $ngops \n"

sz =Caz(PV)

<<" %v $npleth $sz \n"

STOP!
